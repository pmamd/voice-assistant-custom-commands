<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800" width="1200" height="800">
  <defs>
    <style>
      .box { fill: #f0f0f0; stroke: #333; stroke-width: 2; }
      .component { fill: #4a90e2; stroke: #2e5c8a; stroke-width: 2; }
      .process { fill: #50c878; stroke: #2d7a4a; stroke-width: 2; }
      .data { fill: #ffd700; stroke: #b8860b; stroke-width: 2; }
      .title { font: bold 18px sans-serif; fill: #fff; text-anchor: middle; }
      .text { font: 14px sans-serif; fill: #333; }
      .small-text { font: 12px sans-serif; fill: #666; }
      .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .data-arrow { stroke: #e67e22; stroke-width: 2; fill: none; marker-end: url(#data-arrowhead); }
      .label { font: 13px sans-serif; fill: #333; }
      .phase { font: bold 16px sans-serif; fill: #2c3e50; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
    <marker id="data-arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#e67e22" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="30" class="phase" text-anchor="middle" font-size="20">Voice Assistant Test Harness Architecture</text>

  <!-- Phase 1: Audio Generation -->
  <text x="100" y="80" class="phase">Phase 1: Generate Test Input</text>
  <rect x="50" y="100" width="220" height="100" class="component" rx="5"/>
  <text x="160" y="125" class="title">Audio Generator</text>
  <text x="160" y="150" class="small-text">audio_generator.py</text>
  <text x="70" y="175" class="small-text">• Piper TTS Engine</text>
  <text x="70" y="190" class="small-text">• Generates WAV files</text>

  <rect x="50" y="220" width="220" height="60" class="data" rx="5"/>
  <text x="160" y="245" class="label">test_input.wav</text>
  <text x="160" y="265" class="small-text">"Hello assistant" (22.05kHz)</text>

  <!-- Arrow from generator to input file -->
  <path d="M 160 200 L 160 220" class="data-arrow"/>

  <!-- Phase 2: Test Execution -->
  <text x="400" y="80" class="phase">Phase 2: System Under Test</text>
  <rect x="320" y="100" width="240" height="180" class="component" rx="5"/>
  <text x="440" y="125" class="title">talk-llama-custom</text>
  <text x="440" y="145" class="small-text">(Test Mode: --test-input)</text>

  <!-- Sub-components -->
  <rect x="330" y="155" width="220" height="30" class="box" rx="3"/>
  <text x="440" y="175" class="small-text">1. Whisper STT → Transcribe</text>

  <rect x="330" y="190" width="220" height="30" class="box" rx="3"/>
  <text x="440" y="210" class="small-text">2. LLaMA → Generate Response</text>

  <rect x="330" y="225" width="220" height="30" class="box" rx="3"/>
  <text x="440" y="245" class="small-text">3. Send to Wyoming-Piper TTS</text>

  <!-- Arrow from input to talk-llama -->
  <path d="M 270 250 L 320 190" class="arrow"/>
  <text x="280" y="210" class="label">Inject</text>

  <!-- Wyoming-Piper TTS Server -->
  <rect x="620" y="100" width="240" height="140" class="component" rx="5"/>
  <text x="740" y="125" class="title">Wyoming-Piper Server</text>
  <text x="740" y="145" class="small-text">(Test Mode: --test-mode)</text>
  <text x="630" y="170" class="small-text">• Receives TTS request via HTTP</text>
  <text x="630" y="190" class="small-text">• Generates audio with Piper</text>
  <text x="630" y="210" class="small-text">• Saves to file (no playback)</text>

  <!-- Arrow from talk-llama to Wyoming-Piper -->
  <path d="M 560 190 L 620 170" class="arrow"/>
  <text x="580" y="175" class="label">HTTP POST</text>

  <!-- Output file -->
  <rect x="620" y="260" width="240" height="60" class="data" rx="5"/>
  <text x="740" y="285" class="label">output.wav</text>
  <text x="740" y="305" class="small-text">TTS response (22.05kHz)</text>

  <!-- Arrow from Wyoming-Piper to output -->
  <path d="M 740 240 L 740 260" class="data-arrow"/>

  <!-- Phase 3: Verification -->
  <text x="950" y="80" class="phase">Phase 3: Verify Output</text>
  <rect x="910" y="100" width="240" height="120" class="component" rx="5"/>
  <text x="1030" y="125" class="title">Audio Verifier</text>
  <text x="1030" y="145" class="small-text">audio_verifier.py</text>
  <text x="920" y="170" class="small-text">• Resample to 16kHz (ffmpeg)</text>
  <text x="920" y="190" class="small-text">• Whisper STT transcribe</text>
  <text x="920" y="210" class="small-text">• Compare with expected</text>

  <!-- Arrow from output to verifier -->
  <path d="M 860 290 L 910 180" class="arrow"/>
  <text x="870" y="220" class="label">Verify</text>

  <!-- Test Results -->
  <rect x="910" y="240" width="240" height="100" class="data" rx="5"/>
  <text x="1030" y="265" class="label">Test Results</text>
  <text x="920" y="285" class="small-text">• Transcription: "Hello! How..."</text>
  <text x="920" y="305" class="small-text">• Similarity: 85%</text>
  <text x="920" y="325" class="small-text">• Status: PASS ✓</text>

  <!-- Arrow from verifier to results -->
  <path d="M 1030 220 L 1030 240" class="data-arrow"/>

  <!-- Orchestrator at the bottom -->
  <text x="600" y="390" class="phase">Test Orchestration Layer</text>
  <rect x="300" y="410" width="600" height="100" class="process" rx="5"/>
  <text x="600" y="435" class="title">Test Harness (run_tests.py)</text>
  <text x="310" y="460" class="small-text">• Loads test_cases.yaml</text>
  <text x="310" y="480" class="small-text">• Manages Wyoming-Piper server</text>
  <text x="310" y="495" class="small-text">• Coordinates test execution</text>

  <text x="590" y="460" class="small-text">• Parallel test execution</text>
  <text x="590" y="480" class="small-text">• Timeout handling</text>
  <text x="590" y="495" class="small-text">• Generates reports</text>

  <!-- Arrows from orchestrator to components -->
  <path d="M 350 410 L 160 280" class="arrow" stroke-dasharray="5,5"/>
  <path d="M 600 410 L 440 280" class="arrow" stroke-dasharray="5,5"/>
  <path d="M 850 410 L 740 320" class="arrow" stroke-dasharray="5,5"/>
  <path d="M 850 410 L 1030 340" class="arrow" stroke-dasharray="5,5"/>

  <!-- Test Configuration -->
  <rect x="50" y="550" width="280" height="220" class="box" rx="5"/>
  <text x="190" y="575" class="label" font-weight="bold">Test Configuration</text>
  <text x="60" y="600" class="small-text">test_cases.yaml:</text>
  <text x="70" y="620" class="small-text">• Test cases definitions</text>
  <text x="70" y="640" class="small-text">• Expected outputs</text>
  <text x="70" y="660" class="small-text">• Verification criteria</text>
  <text x="70" y="680" class="small-text">• Test groups (smoke, functional,</text>
  <text x="70" y="695" class="small-text">  command, quality, performance)</text>
  <text x="60" y="720" class="small-text">Config:</text>
  <text x="70" y="740" class="small-text">• Model paths</text>
  <text x="70" y="755" class="small-text">• Timeouts and thresholds</text>

  <!-- Data Flow -->
  <rect x="380" y="550" width="280" height="220" class="box" rx="5"/>
  <text x="520" y="575" class="label" font-weight="bold">Data Flow</text>

  <text x="390" y="605" class="label" font-size="12" font-weight="bold">1. Input Generation:</text>
  <text x="400" y="625" class="small-text">Text → Piper → WAV (22kHz)</text>

  <text x="390" y="650" class="label" font-size="12" font-weight="bold">2. Processing:</text>
  <text x="400" y="670" class="small-text">WAV → Whisper → Text</text>
  <text x="400" y="685" class="small-text">Text → LLaMA → Response</text>
  <text x="400" y="700" class="small-text">Response → Piper → WAV</text>

  <text x="390" y="725" class="label" font-size="12" font-weight="bold">3. Verification:</text>
  <text x="400" y="745" class="small-text">WAV → Resample → 16kHz WAV</text>
  <text x="400" y="760" class="small-text">16kHz WAV → Whisper → Text</text>

  <!-- Test Types -->
  <rect x="710" y="550" width="280" height="220" class="box" rx="5"/>
  <text x="850" y="575" class="label" font-weight="bold">Test Types</text>

  <text x="720" y="605" class="label" font-size="12" font-weight="bold">Functional Tests:</text>
  <text x="730" y="625" class="small-text">• Greetings, Q&A, conversations</text>

  <text x="720" y="650" class="label" font-size="12" font-weight="bold">Command Tests:</text>
  <text x="730" y="670" class="small-text">• Stop, exit commands</text>
  <text x="730" y="685" class="small-text">• Command variations</text>

  <text x="720" y="710" class="label" font-size="12" font-weight="bold">Interrupt Tests:</text>
  <text x="730" y="730" class="small-text">• Stop during TTS playback</text>
  <text x="730" y="745" class="small-text">• System responsiveness</text>

  <text x="720" y="765" class="label" font-size="12" font-weight="bold">Quality Tests:</text>
  <text x="730" y="785" class="small-text">• Transcription accuracy</text>

  <!-- Legend -->
  <rect x="1020" y="550" width="160" height="150" class="box" rx="5"/>
  <text x="1100" y="575" class="label" font-weight="bold">Legend</text>

  <rect x="1030" y="590" width="40" height="20" class="component" rx="2"/>
  <text x="1080" y="605" class="small-text">Component</text>

  <rect x="1030" y="620" width="40" height="20" class="process" rx="2"/>
  <text x="1080" y="635" class="small-text">Process</text>

  <rect x="1030" y="650" width="40" height="20" class="data" rx="2"/>
  <text x="1080" y="665" class="small-text">Data/File</text>

  <line x1="1030" y1="685" x2="1070" y2="685" class="arrow"/>
  <text x="1080" y="690" class="small-text">Process Flow</text>

  <line x1="1030" y1="710" x2="1070" y2="710" class="data-arrow"/>
  <text x="1080" y="715" class="small-text">Data Flow</text>
</svg>
